<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Stock Market Analysis</title>

<style>
  /* ========= THEME & TOKENS ========= */
  :root {
    --bg: #0b1020;             /* deep night */
    --panel: rgba(18, 24, 40, .72);
    --card: rgba(24, 31, 52, .66);
    --text: #e8ecf3;
    --muted: #a6b0c3;
    --border: rgba(255,255,255,.08);
    --accent: #18d07a;         /* emerald neon */
    --accent-2: #8b5cf6;       /* violet */
    --accent-3: #22d3ee;       /* cyan */
    --radius-lg: 20px;
    --radius-sm: 12px;
    --shadow-1: 0 10px 50px rgba(2,6,23,.55);
    --shadow-2: 0 6px 20px rgba(2,6,23,.45);
  }

  * { box-sizing: border-box; }
  html, body { height: 100%; }
  body {
    margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, sans-serif;
    color: var(--text); background: var(--bg);
    -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
  }

  /* ========= ART BACKGROUND (animated aurora) ========= */
  .backdrop {
    position: fixed; inset: 0; z-index: -1; overflow: hidden;
    background:
      radial-gradient(1200px 800px at 75% -10%, rgba(34,211,238,.18), transparent 50%),
      radial-gradient(900px 700px at -10% 20%, rgba(139,92,246,.20), transparent 55%),
      radial-gradient(700px 600px at 110% 90%, rgba(24,208,122,.18), transparent 60%),
      radial-gradient(1200px 1000px at 50% 120%, rgba(34,211,238,.13), transparent 60%);
    filter: saturate(120%);
  }
  .backdrop::before,
  .backdrop::after {
    content: ""; position: absolute; inset: -20%;
    background: conic-gradient(
      from 0deg,
      rgba(34,211,238,.12),
      rgba(139,92,246,.12),
      rgba(24,208,122,.12),
      rgba(34,211,238,.12)
    );
    animation: swirl 18s linear infinite;
    mix-blend-mode: screen; pointer-events: none;
  }
  .backdrop::after { animation-duration: 28s; animation-direction: reverse; opacity: .6; }
  @keyframes swirl { to { transform: rotate(360deg); } }
  @media (prefers-reduced-motion: reduce) {
    .backdrop::before, .backdrop::after { animation: none; }
  }

  /* ========= LAYOUT ========= */
  .wrap { max-width: 1280px; margin: 36px auto; padding: 0 20px; }
  header { margin-bottom: 18px; }
  h1 {
    font-size: clamp(1.6rem, 1.2rem + 1.6vw, 2.2rem); margin: 0 0 8px;
    background: linear-gradient(90deg, #e8ecf3, #c9d7ff 40%, #9fe1ff 70%, #e8ecf3);
    -webkit-background-clip: text; background-clip: text; color: transparent;
    letter-spacing: .3px;
  }
  .sub { color: var(--muted); font-size: .98rem; }

  /* ========= GLASS PANELS ========= */
  .panel, .card {
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-1);
    backdrop-filter: blur(9px) saturate(120%);
  }
  .panel { padding: 20px; }

  /* ========= FLASHES ========= */
  .errors {
    list-style: none; margin: 0 0 14px; padding: 10px 12px;
    background: linear-gradient(180deg, rgba(24,31,52,.9), rgba(24,31,52,.75));
    border: 1px solid var(--border); border-radius: var(--radius-sm);
  }
  .errors li { margin: 3px 0; }
  .errors .error { color: #fca5a5; }
  .errors .success { color: #86efac; }

  /* ========= FORM ========= */
  form {
    display: grid; gap: 14px; align-items: end;
    grid-template-columns: repeat(12, 1fr);
  }
  .field { display: grid; gap: 6px; }
  label { font-size: .92rem; color: var(--muted); }

  /* Inputs (stay dark-themed) */
  input[type="text"] {
    background: linear-gradient(180deg, rgba(31,41,67,.85), rgba(28,37,61,.7));
    color: var(--text);
    border: 1px solid var(--border); border-radius: 12px;
    padding: 12px 14px; min-height: 46px; outline: none;
    box-shadow: inset 0 1px 0 rgba(255,255,255,.03);
    transition: box-shadow .2s ease, border-color .2s ease, transform .06s ease;
  }
  input[type="text"]:focus {
    border-color: rgba(34,211,238,.7);
    box-shadow: 0 0 0 3px rgba(34,211,238,.15);
  }
  input[type="text"]:active { transform: translateY(1px); }
  input::placeholder { color: #64748b; }

  /* ======= SELECTS (black font on light box as requested) ======= */
  select {
    color: #000;                                   /* black font */
    background: #f3f4f6 !important;                /* light gray background */
    border: 1px solid #cbd5e1;                     /* light border */
    border-radius: 12px;
    padding: 12px 14px;
    min-height: 46px;
    outline: none;
    transition: box-shadow .2s ease, border-color .2s ease, transform .06s ease;
  }
  select:focus {
    border-color: #94a3b8;
    box-shadow: 0 0 0 3px rgba(34,211,238,.22);
  }
  select:active { transform: translateY(1px); }
  /* Dropdown menu items */
  select option,
  select optgroup {
    color: #000;
    background: #ffffff;
  }

  .field--ticker   { grid-column: span 5; }
  .field--duration { grid-column: span 3; }
  .field--sma      { grid-column: span 2; }
  .actions         { grid-column: span 2; display: flex; gap: 10px; }

  @media (max-width: 980px) {
    .field--ticker   { grid-column: span 12; }
    .field--duration { grid-column: span 6; }
    .field--sma      { grid-column: span 6; }
    .actions         { grid-column: span 12; }
  }

  /* ========= BUTTONS (neon rings) ========= */
  .btn, a.btn {
    --glow: 0 0 0 rgba(24,208,122,0);
    display: inline-flex; align-items: center; justify-content: center; gap: 8px;
    text-decoration: none; cursor: pointer; user-select: none;
    min-height: 46px; padding: 10px 16px; border-radius: 12px;
    font-weight: 700; letter-spacing: .2px;
    color: #031a11; background: linear-gradient(180deg, #20e191, #13c174);
    border: 1px solid rgba(24,208,122,.7);
    box-shadow: var(--glow), inset 0 6px 8px rgba(255,255,255,.06), inset 0 -6px 8px rgba(0,0,0,.15);
    transition: transform .08s ease, box-shadow .2s ease, filter .2s ease;
  }
  .btn:hover, a.btn:hover {
    transform: translateY(-1px);
    box-shadow:
      0 10px 30px rgba(24,208,122,.28),
      0 0 0 3px rgba(34,211,238,.12);
    filter: saturate(1.1);
  }
  .btn:active, a.btn:active { transform: translateY(0); box-shadow: var(--shadow-2); }
  .btn.sec, a.btn.sec {
    color: #0e0531; background: linear-gradient(180deg, #a78bfa, #7c5cf8);
    border-color: rgba(139,92,246,.65);
  }

  /* ========= RESULTS ========= */
  .results { display: grid; gap: 22px; margin-top: 20px; }
  .plot-row {
    display: grid; gap: 18px;
    grid-template-columns: minmax(0, 3fr) minmax(280px, 1fr);
    align-items: start;
  }
  @media (max-width: 1180px) {
    .plot-row { grid-template-columns: 1fr; }
  }

  .plot-card { padding: 0; overflow: hidden; }
  .plot-head {
    padding: 16px 18px 8px; color: var(--muted);
    display: flex; justify-content: space-between; align-items: center;
  }
  .badge {
    padding: 6px 10px; border-radius: 999px; font-size: .78rem; font-weight: 700;
    color: #001a14; background: linear-gradient(180deg, #67e8f9, #22d3ee);
    border: 1px solid rgba(34,211,238,.55);
  }
  .plot-body { padding: 6px 12px 14px; }
  .plot-card .js-plotly-plot, .plot-card .plotly-graph-div { width: 100% !important; height: auto !important; }

  .dl-wrap { display: flex; gap: 12px; padding: 0 18px 18px; flex-wrap: wrap; }
  .card { padding: 16px; border-radius: var(--radius-lg); }

  /* ========= FANCY SUMMARY (glass table) ========= */
  .summary-card h4 { margin: 0 0 8px; font-size: 1.06rem; letter-spacing: .3px; }
  .summary-card table {
    width: 100%; border-collapse: collapse; font-size: .96rem;
    background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.00));
    border-radius: 14px; overflow: hidden;
  }
  .summary-card tr + tr td { border-top: 1px dashed rgba(255,255,255,.08); }
  .summary-card td { padding: 10px 8px; text-align: left; }
  .summary-card td:first-child { color: var(--muted); width: 58%; }
  .pill {
    display: inline-block; padding: 4px 8px; border-radius: 999px; font-weight: 700; font-size: .86rem;
    background: linear-gradient(180deg, rgba(34,211,238,.16), rgba(34,211,238,.06));
    border: 1px solid rgba(34,211,238,.25); color: #c6f9ff;
  }

  /* CSS-only accordion for extra notes under each ticker */
  details {
    margin-top: 10px; background: rgba(255,255,255,.02); border: 1px solid var(--border);
    border-radius: 12px; padding: 10px 12px;
    transition: border-color .2s ease, background .2s ease;
  }
  details[open] { background: rgba(255,255,255,.04); border-color: rgba(34,211,238,.35); }
  summary {
    list-style: none; cursor: pointer; color: var(--muted); font-weight: 700;
    display: flex; align-items: center; gap: 10px;
  }
  summary::-webkit-details-marker { display: none; }
  summary::before {
    content: "â–¸"; transform: translateY(1px); transition: transform .2s ease;
    color: #7bd0ff;
  }
  details[open] summary::before { transform: rotate(90deg) translateX(1px); }

  .note { color: var(--muted); font-size: .93rem; margin-top: 8px; }
  .danger { color: #fca5a5; }

  /* Subtle border glow on hover for cards */
  .card:hover { border-color: rgba(34,211,238,.32); }
</style>
</head>

<body>
  <div class="backdrop" aria-hidden="true"></div>

  <div class="wrap">
    <header>
      <h1>Stock Market Analysis</h1>
      <div class="sub">Enter a ticker, duration, and SMA to generate a chart and a glassy summary.</div>
    </header>

    <section class="panel">
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <ul class="errors" aria-live="polite">
            {% for category, msg in messages %}
              <li class="{{ category }}">{{ msg }}</li>
            {% endfor %}
          </ul>
        {% endif %}
      {% endwith %}

      <form action="/" method="POST" novalidate>
        <div class="field field--ticker">
          <label for="ticker">Ticker</label>
          <input type="text" id="ticker" name="ticker" placeholder="AAPL" value="{{ ticker or '' }}" style="text-transform: uppercase;" />
        </div>

        <div class="field field--duration">
          <label for="duration">Duration</label>
          <select id="duration" name="duration">
            {% set durations = ['1mo','3mo','6mo','1y','2y','3y'] %}
            {% for d in durations %}
              <option value="{{ d }}" {% if duration==d %}selected{% endif %}>{{ d }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="field field--sma">
          <label for="sma">SMA Period</label>
          <select id="sma" name="sma">
            {% set sma_opts = [5,10,20,50,100,200] %}
            {% for w in sma_opts %}
              <option value="{{ w }}" {% if sma and (sma|int)==w %}selected{% endif %}>{{ w }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="actions">
          <button class="btn" type="submit">Run Analysis</button>
          {% if analysis_key %}
            <a class="btn sec" href="{{ url_for('download_all_zip', key=analysis_key) }}">Download All (ZIP)</a>
          {% endif %}
        </div>
      </form>

      {% if note %}
        <div class="note">{{ note }}</div>
      {% endif %}
    </section>

    <section class="results">
      {% if plots %}
        {% for p in plots %}
        {% set i = loop.index0 %}
        <div class="plot-row">
          <!-- Chart -->
          <section class="card plot-card">
            <div class="plot-head">
              <div>ðŸ“ˆ Ticker: <strong style="color:#fff">{{ p.ticker }}</strong></div>
              <span class="badge">Interactive</span>
            </div>
            <div class="plot-body">
              {{ p.plot | safe }}
            </div>
            <div class="dl-wrap">
              <a class="btn" href="{{ url_for('download_csv', key=analysis_key, ticker=p.ticker) }}">Download {{ p.ticker }} CSV</a>
            </div>

            <div style="padding: 0 18px 18px;">
              <details>
                <summary>Notes & definitions</summary>
                <div class="note" style="margin-top:8px">
                  Longest run = consecutive trading days moving up or down. Max Profit is computed by your backend function and shown here without modification.
                </div>
              </details>
            </div>
          </section>

          <!-- Summary -->
          <aside class="card summary-card">
            {% if summaries and summaries|length > i %}
              {% set s = summaries[i] %}
              <h4>Summary</h4>
              <table>
                <tbody>
                  <tr><td>Longest Up Run</td><td><span class="pill">{{ s.longest_up_streak }}</span></td></tr>
                  <tr><td>Longest Down Run</td><td><span class="pill">{{ s.longest_down_streak }}</span></td></tr>
                  <tr><td># Up Days</td><td><span class="pill">{{ s.up_count }}</span></td></tr>
                  <tr><td># Down Days</td><td><span class="pill">{{ s.down_count }}</span></td></tr>
                  <tr><td># Up Runs</td><td><span class="pill">{{ s.up_run_count }}</span></td></tr>
                  <tr><td># Down Runs</td><td><span class="pill">{{ s.down_run_count }}</span></td></tr>
                  <tr><td>Max Profit (USD)</td><td><span class="pill">{{ s.max_profit }}</span></td></tr>
                  <tr><td>Avg Daily Return (%)</td><td><span class="pill">{{ s.avg_daily_return }}%</span></td></tr>
                </tbody>
              </table>
              <details style="margin-top:12px">
                <summary>Methodology</summary>
                <div class="note" style="margin-top:8px">
                  Values derive from your analysis pipeline for the selected duration and SMA window.
                </div>
              </details>
            {% else %}
              <div class="note">Summary not available.</div>
            {% endif %}
          </aside>
        </div>
        {% endfor %}
      {% else %}
        <div class="note">Submit the form to render a chart.</div>
      {% endif %}
    </section>

    {% if error %}
      <p class="danger">{{ error }}</p>
    {% endif %}
  </div>
</body>
</html>
